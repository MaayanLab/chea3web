# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "Skin_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "f78da4a1855ff20da768eed1b73508be"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted or is out of date. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "f78da4a1855ff20da768eed1b73508be"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://maayanlab.cloud/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM1246807","GSM1183336","GSM1131155","GSM1246817","GSM1246818","GSM1246810","GSM1187136","GSM1246821","GSM1183338","GSM1183334","GSM1131156","GSM1187137","GSM1183335","GSM1246806","GSM1246811","GSM1246819","GSM1246820","GSM1246809","GSM1246816","GSM1183337","GSM1246808","GSM1539029","GSM1539030","GSM1539040","GSM1539036","GSM1655582","GSM1539041","GSM1539011","GSM1539031","GSM1342486","GSM1539042",
"GSM1538999","GSM1539035","GSM1296623","GSM1539038","GSM1557578","GSM1539032","GSM1432457","GSM1539037","GSM1907120","GSM1539034","GSM1539026","GSM1557581","GSM1539023","GSM1539039","GSM1907125","GSM1539033","GSM1655580","GSM1539000","GSM1338762","GSM1907123","GSM1907119","GSM1358448","GSM1539019","GSM1338760","GSM1539015","GSM1432460","GSM1539018","GSM1907121","GSM1538995","GSM1538996",
"GSM1296626","GSM1432462","GSM1538998","GSM1312927","GSM1296625","GSM1539021","GSM1539009","GSM1539022","GSM1338759","GSM1655583","GSM1373736","GSM1539020","GSM1655581","GSM1655578","GSM1539028","GSM1296629","GSM1539012","GSM1373735","GSM1432463","GSM1539010","GSM1432456","GSM1432465","GSM1539013","GSM1432455","GSM1539007","GSM1539006","GSM1557582","GSM1907122","GSM1539001","GSM1655584",
"GSM1539008","GSM1358449","GSM1557579","GSM1907118","GSM1557576","GSM1539014","GSM1539004","GSM1538997","GSM1312923","GSM1338761","GSM1432459","GSM1539025","GSM1539016","GSM1557580","GSM1312922","GSM1539002","GSM1655577","GSM2058389","GSM1557577","GSM1296627","GSM1358452","GSM1338763","GSM1358450","GSM1432454","GSM1373737","GSM2058390","GSM1432461","GSM1539027","GSM1907126","GSM1312926",
"GSM1432452","GSM1296628","GSM1539005","GSM1557575","GSM1432453","GSM1342491","GSM1655579","GSM1342489","GSM1907124","GSM1432464","GSM1539017","GSM2058388","GSM1342490","GSM1342484","GSM1342485","GSM1432458","GSM1342483","GSM1358447","GSM1965469","GSM1965530","GSM2050828","GSM2050850","GSM1965435","GSM1632426","GSM2050865","GSM1599207","GSM2050835","GSM1965514","GSM1965505","GSM2050830",
"GSM2050831","GSM2050858","GSM1965482","GSM1965403","GSM2050869","GSM1599213","GSM1965411","GSM2050867","GSM2050846","GSM1599211","GSM1965472","GSM1409341","GSM1930369","GSM2050857","GSM1965397","GSM1599195","GSM1599202","GSM1964950","GSM1965504","GSM1599208","GSM2139816","GSM2050849","GSM1965439","GSM1965466","GSM1965408","GSM1965502","GSM1965409","GSM2050860","GSM1965489","GSM1965473",
"GSM2050829","GSM1965493","GSM2050838","GSM1965378","GSM1965441","GSM1965465","GSM2050840","GSM2050832","GSM1965380","GSM1930372","GSM1965516","GSM2050833","GSM1965486","GSM1965417","GSM1965462","GSM1965480","GSM1965515","GSM1965488","GSM1965432","GSM2050852","GSM2050847","GSM1965478","GSM1965463","GSM1965517","GSM2050856","GSM1965501","GSM1930371","GSM1965500","GSM1965522","GSM1965532",
"GSM1965430","GSM1965413","GSM1965487","GSM1965426","GSM1409339","GSM1965406","GSM1409335","GSM1965498","GSM2050845","GSM1965394","GSM1965415","GSM1965457","GSM1965424","GSM1965531","GSM1930376","GSM1965452","GSM1965526","GSM1965529","GSM1965402","GSM2050853","GSM1965521","GSM1965428","GSM1965512","GSM1965495","GSM1965485","GSM1965484","GSM1965510","GSM1599203","GSM1930374","GSM1965523",
"GSM1965476","GSM2050843","GSM1965464","GSM1599212","GSM1965483","GSM1599190","GSM1965421","GSM2050848","GSM2050836","GSM1965528","GSM1965420","GSM2050844","GSM1965451","GSM1965410","GSM2050834","GSM1965468","GSM1965390","GSM1965440","GSM1613677","GSM2050839","GSM1965433","GSM1599191","GSM1965398","GSM1965431","GSM1599204","GSM1965459","GSM1965470","GSM1965507","GSM1965506","GSM2050842",
"GSM1965381","GSM1965481","GSM1965379","GSM1599197","GSM1965442","GSM1965437","GSM1965467","GSM1409338","GSM1965447","GSM1965389","GSM1965423","GSM1409336","GSM1632430","GSM1965475","GSM1965438","GSM2050864","GSM1965461","GSM1965382","GSM1930370","GSM1930380","GSM2050827","GSM1965391","GSM1930382","GSM2050855","GSM2050841","GSM2050859","GSM1965518","GSM1599192","GSM1965490","GSM1965395",
"GSM2050851","GSM2050861","GSM1930378","GSM1965446","GSM1965450","GSM1965477","GSM1965419","GSM1965519","GSM1965377","GSM1965513","GSM1965436","GSM1965533","GSM1964949","GSM1965414","GSM1599209","GSM1599196","GSM1965479","GSM1965471","GSM1930375","GSM1965454","GSM1965449","GSM1599206","GSM1965393","GSM2050837","GSM1965535","GSM1632425","GSM1632423","GSM2050868","GSM1965429","GSM1965494",
"GSM2050870","GSM1965396","GSM1409337","GSM1965508","GSM1599210","GSM1965496","GSM1965491","GSM1965392","GSM1965418","GSM1965385","GSM1965422","GSM1599205","GSM1965401","GSM1965520","GSM1599200","GSM1965499","GSM1930379","GSM1965399","GSM1965458","GSM1965405","GSM1965492","GSM2050866","GSM1965400","GSM1965427","GSM1599198","GSM1964948","GSM1930381","GSM2050854","GSM1965416","GSM1599201",
"GSM1965509","GSM1599199","GSM1930373","GSM1965474","GSM1632422","GSM1965448","GSM1965525","GSM1965384","GSM1965425","GSM1965445","GSM1965527","GSM2050872","GSM2050871","GSM1965497","GSM1965404","GSM1632427","GSM1965386","GSM1965453","GSM1965460","GSM1409334","GSM1965444","GSM1930367","GSM1409340","GSM1599193","GSM1965434","GSM1965456","GSM1930368","GSM1965407","GSM1965443","GSM1965511",
"GSM2050863","GSM1965455","GSM1965388","GSM1632432","GSM1965524","GSM1965387","GSM1965534","GSM1632431","GSM1965383","GSM1599194","GSM1965503","GSM1965412","GSM1632424","GSM1930377","GSM1342492","GSM1358451","GSM1539024","GSM1539003","GSM1859141","GSM1859142","GSM1859138","GSM1859143","GSM1859140","GSM1859139","GSM2393541","GSM2393512","GSM2393511","GSM2393540","GSM2393527","GSM2393548",
"GSM2393547","GSM2393542","GSM2393546","GSM2393543","GSM2393539","GSM2393528","GSM2393544","GSM2393537","GSM2393545","GSM2393538","GSM2285813","GSM2285812","GSM2285811","GSM2285810","GSM2285817","GSM2285819","GSM2285815","GSM2285789","GSM2285816","GSM2285798","GSM2285794","GSM2285795","GSM2285790","GSM2285791","GSM2285792","GSM2285793","GSM2285759","GSM2285799","GSM2285796","GSM2285797",
"GSM2285770","GSM2285814","GSM2285778","GSM2285779","GSM2285776","GSM2285777","GSM2285774","GSM2285775","GSM2285772","GSM2285773","GSM2285771","GSM2285818","GSM2285828","GSM2285829","GSM2285822","GSM2285823","GSM2285820","GSM2285826","GSM2285827","GSM2285824","GSM2285825","GSM2285821","GSM2285769","GSM2285768","GSM2285765","GSM2285764","GSM2285767","GSM2285766","GSM2285761","GSM2285760",
"GSM2285763","GSM2285762","GSM2285783","GSM2285782","GSM2285781","GSM2285780","GSM2285787","GSM2285786","GSM2285785","GSM2285831","GSM2285830","GSM2285784","GSM2285788","GSM2285758","GSM2285742","GSM2285750","GSM2285751","GSM2285752","GSM2285753","GSM2285754","GSM2285755","GSM2285756","GSM2285757","GSM2285808","GSM2285809","GSM2285804","GSM2285805","GSM2285806","GSM2285807","GSM2285800",
"GSM2285801","GSM2285802","GSM2285803","GSM2285747","GSM2285746","GSM2285745","GSM2285744","GSM2285743","GSM2285741","GSM2285749","GSM2285748","GSM2072396","GSM2072397","GSM2071286","GSM2343233","GSM2072481","GSM2072482","GSM2072483","GSM2072484","GSM2343564","GSM2343712","GSM1062446","GSM1062447","GSM1062444","GSM1062445","GSM1062443","GSM1062448","GSM1062449","GSM1101668","GSM1101666",
"GSM1101667","GSM1101665","GSM2071285","GSM1101680","GSM1101681","GSM2343747","GSM2344419","GSM2343729","GSM2343841","GSM2344268","GSM1062451","GSM1062450","GSM1062452","GSM2039424","GSM2039426","GSM2039427","GSM2039425","GSM2052590","GSM2052588","GSM2052586","GSM2052589","GSM2052587","GSM2052591","GSM2231180","GSM2231164","GSM2231161","GSM2231162","GSM2231179","GSM2231160","GSM2231181",
"GSM2231178","GSM2231174","GSM2231165","GSM2231175","GSM2231166","GSM2231171","GSM2231173","GSM2231170","GSM2231163","GSM2231182","GSM2231157","GSM2231169","GSM2231168","GSM2231172","GSM2231167","GSM2231158","GSM2231159","GSM2231177","GSM2231176","GSM2328811","GSM2328808","GSM2430709","GSM2430712","GSM2430710","GSM2430711","GSM2448851","GSM2448856","GSM2448855","GSM2448858","GSM2448850",
"GSM2448853","GSM2448852","GSM2448854","GSM2448857","GSM2572310","GSM2572312","GSM2572311","GSM2595195","GSM2595246","GSM2595194","GSM2595267","GSM2595239","GSM2595266","GSM2595259","GSM2595209","GSM2595207","GSM2595258","GSM2595262","GSM2595255","GSM2595264","GSM2595263","GSM2595243","GSM2595236","GSM2595260","GSM2595215","GSM2595250","GSM2595205","GSM2595257","GSM2595252","GSM2595208",
"GSM2595235","GSM2595214","GSM2595206","GSM2595248","GSM2595219","GSM2595193","GSM2595270","GSM2595256","GSM2595228","GSM2595244","GSM2595242","GSM2595203","GSM2595238","GSM2595251","GSM2595245","GSM2595237","GSM2595261","GSM2595247","GSM2595268","GSM2595210","GSM2595218","GSM2595220","GSM2595265","GSM2595211","GSM2595240","GSM2595200","GSM2595225","GSM2595212","GSM2595213","GSM2595249",
"GSM2595198","GSM2595269","GSM2595217","GSM2595196","GSM2595201","GSM2595204","GSM2595232","GSM2595254","GSM2595202","GSM2595241","GSM2595231","GSM2595233","GSM2595221","GSM2595227","GSM2595253","GSM2595222","GSM2595216","GSM2595199","GSM2595230","GSM2595234","GSM2595226","GSM2595224","GSM2595229","GSM2595223","GSM2595197","GSM2476385","GSM2476386","GSM2476399","GSM2476400","GSM2695253",
"GSM2695254","GSM2695255","GSM2695256","GSM2695257","GSM2695258","GSM2695259","GSM2695260","GSM2695261","GSM2695262","GSM2695263","GSM2695264","GSM2695265","GSM2695266","GSM2695267","GSM2695268","GSM2695269","GSM2695270","GSM2695271","GSM2695272","GSM2695273","GSM2695274","GSM2695275","GSM2695276","GSM2281033","GSM2281034","GSM2281035","GSM2281036","GSM2281037","GSM2281038","GSM2281039",
"GSM2281040","GSM2281041","GSM2281042","GSM2281043","GSM2281044","GSM2281045","GSM2281046","GSM2281047","GSM2310374","GSM2310375","GSM2310376","GSM2310380","GSM2310381","GSM2310382","GSM2573277","GSM2573278","GSM2573279","GSM2573280","GSM2573281","GSM2573282","GSM2573283","GSM2573284","GSM2573285","GSM2573286","GSM2573287","GSM2573288","GSM2573289","GSM2573290","GSM2573291","GSM2573292",
"GSM2573293","GSM2573294","GSM2573295","GSM2573296","GSM2732851","GSM2732852","GSM2732853","GSM2732857","GSM2732858","GSM2732859","GSM2732875","GSM2732876","GSM2732877","GSM2732878","GSM2732879","GSM2732880","GSM2732881","GSM2732882","GSM2732883","GSM2747358","GSM2747359","GSM2747360","GSM2747361","GSM2747362","GSM2747363","GSM2747364","GSM2747365","GSM2747366","GSM2747367","GSM2747368",
"GSM2747369","GSM2747370","GSM2747371","GSM2747372","GSM2747373","GSM2747374","GSM2747375","GSM1613581","GSM1613582","GSM1613583","GSM1613584","GSM1613585","GSM1613586","GSM1613587","GSM1613588","GSM1613589","GSM1613590","GSM1613591","GSM1613592","GSM1613593","GSM1613594","GSM1613595","GSM1613596","GSM1613597","GSM1613598","GSM1613599","GSM1613600","GSM1613601","GSM1613602","GSM1613603",
"GSM1613604","GSM1613605","GSM1613606","GSM1613607","GSM1613608","GSM1613609","GSM1613610","GSM1613611","GSM1613612","GSM1613613","GSM1613614","GSM1613615","GSM1613616","GSM1613617","GSM1613618","GSM1613619","GSM1613620","GSM1613621","GSM1613622","GSM1613623","GSM1613624","GSM1613625","GSM1613626","GSM1613627","GSM1613628","GSM1613629","GSM1613630","GSM1613631","GSM1613632","GSM1613633",
"GSM1613634","GSM1613635","GSM1613636","GSM1613637","GSM1613638","GSM1613639","GSM1613640","GSM1613641","GSM1613642","GSM1613643","GSM1613644","GSM1613645","GSM1613646","GSM1613647","GSM1613648","GSM1613649","GSM1613650","GSM1613651","GSM1613652","GSM1613653","GSM1613654","GSM1613655","GSM1613656","GSM1613657","GSM1613658","GSM1613659","GSM1613660","GSM1613661","GSM1613662","GSM1613663",
"GSM1613664","GSM1613665","GSM1613666","GSM1613667","GSM1613668","GSM1613669","GSM1613670","GSM1613671","GSM1613672","GSM1613673","GSM1613674","GSM1613675","GSM1613676","GSM2257559","GSM2257560","GSM2257561","GSM2257562","GSM2257563","GSM2257564","GSM2257565","GSM2257566","GSM2257567","GSM2257568","GSM2257569","GSM2257570","GSM2319585","GSM2319586","GSM2319587","GSM2319588","GSM2319589",
"GSM2319590","GSM2319591","GSM2319592","GSM2319593","GSM2319594","GSM2319595","GSM2319596","GSM2651136","GSM2651137","GSM2651138","GSM2651139","GSM2651140","GSM2651141","GSM2651142","GSM2651143","GSM2651144","GSM2651145","GSM2651146","GSM2651147","GSM2651148","GSM2651149","GSM2651150","GSM2651151","GSM2651152","GSM2651153","GSM2671914","GSM2671915","GSM2308766","GSM2308767","GSM2308768",
"GSM2308770","GSM2308771","GSM2887524","GSM2887525","GSM2887526","GSM2887527","GSM2887528","GSM2887529","GSM1582572","GSM1582573","GSM1582574","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
