# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "Adipose_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "f78da4a1855ff20da768eed1b73508be"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted or is out of date. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "f78da4a1855ff20da768eed1b73508be"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://maayanlab.cloud/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM742937","GSM1128651","GSM1098356","GSM1098368","GSM1229367","GSM1229372","GSM1098314","GSM1098199","GSM1098295","GSM1229368","GSM1229371","GSM1128650","GSM1098205","GSM1098330","GSM1098348","GSM1098214","GSM1098389","GSM1098287","GSM1396740","GSM1599907","GSM1327874","GSM1599906","GSM1599884","GSM1599899","GSM1396722","GSM1599883","GSM1599895","GSM1599924","GSM1808047","GSM1389730","GSM1396750",
"GSM1389726","GSM1808060","GSM1599922","GSM1396742","GSM1396725","GSM1505575","GSM1808051","GSM1808044","GSM1808043","GSM1622603","GSM1599909","GSM1884741","GSM1599908","GSM1599914","GSM1599894","GSM1599900","GSM1884733","GSM1599904","GSM1599892","GSM1808059","GSM1622601","GSM1327878","GSM1327877","GSM1884754","GSM1327880","GSM1389734","GSM1396729","GSM1297632","GSM1808046","GSM1599887",
"GSM1327876","GSM1599916","GSM1297640","GSM1297636","GSM1808057","GSM1599885","GSM1808053","GSM1327879","GSM1396738","GSM1396735","GSM1599905","GSM1808058","GSM1884735","GSM1599917","GSM1389727","GSM1389735","GSM1808045","GSM1599901","GSM1622596","GSM1389736","GSM1297624","GSM1327875","GSM1599882","GSM1622592","GSM1599902","GSM1297633","GSM1622600","GSM1599888","GSM1599923","GSM1297645",
"GSM1884738","GSM1599911","GSM1396724","GSM1389722","GSM1622595","GSM1297631","GSM1599898","GSM1622598","GSM1297634","GSM1808061","GSM1297630","GSM1884736","GSM1297641","GSM1884757","GSM1599897","GSM1389724","GSM1599918","GSM1599881","GSM1297629","GSM1884749","GSM1396728","GSM1389723","GSM1599910","GSM1622588","GSM1389725","GSM1396749","GSM1396726","GSM1622590","GSM1297628","GSM1297625",
"GSM1622599","GSM1396741","GSM1808055","GSM1599893","GSM1884751","GSM1599896","GSM1808048","GSM1396748","GSM1396721","GSM1599919","GSM1884767","GSM1808065","GSM1297639","GSM1297646","GSM1622602","GSM1396736","GSM1389731","GSM1599915","GSM1622597","GSM1297627","GSM1808052","GSM1396733","GSM1599903","GSM1884764","GSM1599921","GSM1884734","GSM1389721","GSM1389737","GSM1884746","GSM1808066",
"GSM1396743","GSM1808050","GSM1396734","GSM1389733","GSM1297635","GSM1297644","GSM1389729","GSM1297626","GSM1808064","GSM1808049","GSM1297643","GSM1396727","GSM1808054","GSM1808062","GSM1599913","GSM1599890","GSM1396744","GSM1389728","GSM1599886","GSM1389732","GSM1599920","GSM1297642","GSM1884759","GSM1396737","GSM1808056","GSM1884762","GSM1622594","GSM1599889","GSM1389720","GSM1297637",
"GSM1808042","GSM1808063","GSM1505600","GSM1884770","GSM1297666","GSM1973964","GSM1297650","GSM1297672","GSM1297656","GSM1297671","GSM1297658","GSM1297649","GSM1297674","GSM1973963","GSM1297651","GSM1297663","GSM1297665","GSM1973962","GSM1297667","GSM1297654","GSM1297664","GSM1973965","GSM1297673","GSM1297648","GSM1297660","GSM1973958","GSM1297669","GSM1297661","GSM1297655","GSM1973966",
"GSM1973961","GSM1297675","GSM1297662","GSM1297659","GSM1973959","GSM1297670","GSM1297647","GSM1297653","GSM1297657","GSM1297652","GSM1297668","GSM1973960","GSM1297638","GSM1396739","GSM1396723","GSM1599912","GSM1599891","GSM1622593","GSM1622589","GSM1622591","GSM1884743","GSM2331196","GSM2331197","GSM2331195","GSM2331198","GSM2331199","GSM2331228","GSM2331229","GSM2331220","GSM2331221",
"GSM2331222","GSM2331223","GSM2331224","GSM2331225","GSM2331226","GSM2331227","GSM2331236","GSM2331235","GSM2331234","GSM2331233","GSM2331232","GSM2331231","GSM2331230","GSM2331216","GSM2331207","GSM2331209","GSM2331202","GSM2331203","GSM2331208","GSM2331215","GSM2331214","GSM2331217","GSM2331210","GSM2331218","GSM2331213","GSM2331206","GSM2331204","GSM2331205","GSM2331200","GSM2331201",
"GSM2331211","GSM2331212","GSM2331219","GSM1010958","GSM1120304","GSM1120305","GSM2400238","GSM2400239","GSM2343284","GSM2343775","GSM2344003","GSM2344057","GSM1986828","GSM1986829","GSM1986830","GSM1986831","GSM1986832","GSM1986833","GSM1986834","GSM1986835","GSM1986836","GSM1986837","GSM1986838","GSM1986839","GSM1986840","GSM1986841","GSM1986842","GSM1986843","GSM1986844","GSM1986845",
"GSM1986846","GSM1986847","GSM1986848","GSM1986849","GSM1986850","GSM1986851","GSM1986852","GSM2311124","GSM2311125","GSM2311126","GSM2311127","GSM2311128","GSM2311129","GSM2311130","GSM2311131","GSM2311132","GSM2311133","GSM2311134","GSM2311135","GSM2311136","GSM2311137","GSM2311138","GSM2311139","GSM2311140","GSM2311141","GSM2311142","GSM2311143","GSM2311144","GSM2311145","GSM2311146",
"GSM2311147","GSM2311148","GSM2453431","GSM2453430","GSM2883020","GSM2883021","GSM2883022","GSM2883023","GSM2883024","GSM2883025","GSM2883026","GSM2883027","GSM2883028","GSM2883029","GSM2883030","GSM2883031","GSM2883032","GSM2883033","GSM2883034","GSM2883035","GSM2883036","GSM2883037","GSM2883038","GSM2883039","GSM2883040","GSM2883041","GSM2883042","GSM2883043","GSM2883044","GSM2883045",
"GSM2883046","GSM2883047","GSM2883048","GSM2883049","GSM2883050","GSM2883051","GSM2883052","GSM2883053","GSM2883054","GSM2883055","GSM2883056","GSM2883057","GSM2883058","GSM2883059","GSM2883060","GSM2883061","GSM2883062","GSM2917168","GSM2917169","GSM2917170","GSM2917171","GSM2917172","GSM2917173","GSM2917174","GSM2917175","GSM2917176","GSM2917177","GSM2917178","GSM2917179","GSM2917180",
"GSM2917181","GSM2917182","GSM2917183","GSM2343099","GSM2520157","GSM2520158","GSM2520159","GSM2520160","GSM2520161","GSM2520162","GSM2520163","GSM2520164","GSM2520165","GSM2520166","GSM2520167","GSM2520168","GSM2520169","GSM2520170","GSM2520171","GSM2520172","GSM2520173","GSM2520174","GSM2520175","GSM2520176","GSM2520177","GSM2520178","GSM2520179","GSM2520180","GSM2520181","GSM2520182",
"GSM2520183","GSM2520184","GSM2520185","GSM2520186","GSM2520187","GSM2520188","GSM2520189","GSM2520190","GSM2520191","GSM2520192","GSM2520193","GSM2520194","GSM2520195","GSM2520196","GSM2520197","GSM2520198","GSM2520199","GSM2520200","GSM2520201","GSM2520202","GSM2520203","GSM2520204","GSM2520205","GSM2520206","GSM2520207","GSM2520208","GSM2520209","GSM2520210","GSM2520211","GSM2520212",
"GSM2520213","GSM2520214","GSM2520215","GSM2520216","GSM2520217","GSM2520218","GSM2520219","GSM2520220","GSM2520221","GSM2520222","GSM2520223","GSM2520224","GSM2520225","GSM2520226","GSM2520227","GSM2520228","GSM2520229","GSM2520230","GSM2520231","GSM2520232","GSM2520233","GSM2520234","GSM2520235","GSM2520236","GSM2520237","GSM2520238","GSM2520239","GSM2520240","GSM2520241","GSM2520242",
"GSM2520243","GSM2520244","GSM2520245","GSM2520246","GSM2520247","GSM2520248","GSM2520249","GSM2520250","GSM2520251","GSM2520252","GSM2520253","GSM2520254","GSM2520255","GSM2520256","GSM2520257","GSM2520258","GSM2520259","GSM2520260","GSM2520261","GSM2520262","GSM2520263","GSM2520264","GSM2520265","GSM2520266","GSM2520267","GSM2520268","GSM2520269","GSM2520270","GSM2520271","GSM2520272",
"GSM2520273","GSM2520274","GSM2520275","GSM2520276","GSM2520277","GSM2520278","GSM2520279","GSM2520280","GSM2520281","GSM2520282","GSM2520283","GSM2520284","GSM2520285","GSM2520286","GSM2520287","GSM2520288","GSM2520289","GSM2520290","GSM2520291","GSM2520292","GSM2520293","GSM2520294","GSM2520295","GSM2520296","GSM2520297","GSM2520298","GSM2520299","GSM2520300","GSM2520301","GSM2520302",
"GSM2520303","GSM2520304","GSM2520305","GSM2520306","GSM2520307","GSM2520308","GSM2520309","GSM2520310","GSM2520311","GSM2520312","GSM2520313","GSM2520314","GSM2520315","GSM2520316","GSM2520317","GSM2520318","GSM2520319","GSM2520320","GSM2520321","GSM2520322","GSM2520323","GSM2520324","GSM2520325","GSM2520326","GSM2520327","GSM2520328","GSM2520329","GSM2520330","GSM2520331","GSM2520332",
"GSM2520333","GSM2520334","GSM2520335","GSM2520336","GSM2520337","GSM2520338","GSM2520339","GSM2520340","GSM2520341","GSM2520342","GSM2520343","GSM2520344","GSM2520345","GSM2520346","GSM2520347","GSM2520348","GSM2520349","GSM2520350","GSM2520351","GSM2520352","GSM2520353","GSM2520354","GSM2520355","GSM2520356","GSM2520357","GSM2520358","GSM2520359","GSM2520360","GSM2520361","GSM2520362",
"GSM2520363","GSM2520364","GSM2520365","GSM2520366","GSM2520367","GSM2520368","GSM2520369","GSM2520370","GSM2520371","GSM2520372","GSM2520373","GSM2520374","GSM2520375","GSM2520376","GSM2520377","GSM2520378","GSM2520379","GSM2520380","GSM2520381","GSM2520382","GSM2520383","GSM2520384","GSM2520385","GSM2520386","GSM2520387","GSM2520388","GSM2520389","GSM2520390","GSM2520391","GSM2520392",
"GSM2520393","GSM2520394","GSM2520395","GSM2520396","GSM2520397","GSM2520398","GSM2520399","GSM2520400","GSM2520401","GSM2520402","GSM2520403","GSM2520404","GSM2520405","GSM2520406","GSM2520407","GSM2520408","GSM2520409","GSM2520410","GSM2520411","GSM2520412","GSM2520413","GSM2520414","GSM2520415","GSM2520416","GSM2520417","GSM2520418","GSM2520419","GSM2520420","GSM2520421","GSM2520422",
"GSM2520423","GSM2520424","GSM2520425","GSM2520426","GSM2520427","GSM2520428","GSM2520429","GSM2520430","GSM2520431","GSM2520432","GSM2520433","GSM2520434","GSM2520435","GSM2520436","GSM2520437","GSM2520438","GSM2520439","GSM2520440","GSM2520441","GSM2520442","GSM2520443","GSM2520444","GSM2520445","GSM2520446","GSM2520447","GSM2520448","GSM2520449","GSM2520450","GSM2520451","GSM2520452",
"GSM2520453","GSM2520454","GSM2520455","GSM2520456","GSM2520457","GSM2520458","GSM2520459","GSM2520460","GSM2520461","GSM2520462","GSM2520463","GSM2520464","GSM2520465","GSM2520466","GSM2520467","GSM2520468","GSM2520469","GSM2520470","GSM2520471","GSM2520472","GSM2520473","GSM2520474","GSM2520475","GSM2520476","GSM2520477","GSM2520478","GSM2520479","GSM2520480","GSM2520481","GSM2520482",
"GSM2520483","GSM2520484","GSM2520485","GSM2520486","GSM2520487","GSM2520488","GSM2520489","GSM2520490","GSM2520491","GSM2520492","GSM2520493","GSM2520494","GSM2520495","GSM2520496","GSM2520497","GSM2520498","GSM2520499","GSM2520500","GSM2520501","GSM2520502","GSM2520503","GSM2520504","GSM2520505","GSM2520506","GSM2520507","GSM2520508","GSM2520509","GSM2520510","GSM2520511","GSM2520512",
"GSM2520513","GSM2520514","GSM2520515","GSM2520516","GSM2520517","GSM2520518","GSM2520519","GSM2520520","GSM2520521","GSM2520522","GSM2520523","GSM2520524","GSM2520525","GSM2520526","GSM2520527","GSM2520528","GSM2520529","GSM2520530","GSM2520531","GSM2520532","GSM2520533","GSM2520534","GSM2520535","GSM2520536","GSM2520537","GSM2520538","GSM2552853","GSM2552854","GSM2552855","GSM2552856",
"GSM2552857","GSM2552858","GSM2552859","GSM2552860","GSM2552861","GSM2552862","GSM2552863","GSM2552864","GSM2552865","GSM2552866","GSM2552867","GSM2552868","GSM2552869","GSM2552870","GSM2552871","GSM2552872","GSM1443819","GSM1443820","GSM1443821","GSM1443822","GSM1443823","GSM1443824","GSM1443825","GSM1443826","GSM1443827","GSM1443828","GSM1443829","GSM1443830","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
