# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "Colon_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "f78da4a1855ff20da768eed1b73508be"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted or is out of date. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "f78da4a1855ff20da768eed1b73508be"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://amp.pharm.mssm.edu/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM742941","GSM1228205","GSM1193397","GSM1131541","GSM1228207","GSM1228212","GSM1228208","GSM1228203","GSM1131543","GSM1228204","GSM1228218","GSM1131539","GSM1131552","GSM1131545","GSM1131549","GSM1228210","GSM1228206","GSM1100207","GSM1228219","GSM1100208","GSM1131538","GSM1228214","GSM1228213","GSM1131542","GSM1228215","GSM1228211","GSM1228202","GSM1131550","GSM1131547","GSM1131548","GSM1131546",
"GSM1228209","GSM1131544","GSM1131540","GSM1131551","GSM1228216","GSM1228217","GSM2157838","GSM1872925","GSM2055780","GSM2042136","GSM1872937","GSM1306820","GSM1872913","GSM1872985","GSM1412747","GSM1872905","GSM1872940","GSM2042095","GSM1980054","GSM1505604","GSM2042110","GSM2042067","GSM1980048","GSM2042123","GSM1872935","GSM1528137","GSM1872977","GSM2111661","GSM2042072","GSM2042128",
"GSM1872960","GSM1980050","GSM1872938","GSM2042078","GSM1528135","GSM1872912","GSM2042099","GSM1872922","GSM1872962","GSM2042140","GSM2042071","GSM2042138","GSM1872966","GSM1412748","GSM1872926","GSM2042112","GSM1528139","GSM2042108","GSM2042129","GSM2042143","GSM2042111","GSM1872965","GSM1872928","GSM1872972","GSM1528136","GSM1971013","GSM1872914","GSM2042120","GSM2042125","GSM2042069",
"GSM2330188","GSM1872956","GSM2042137","GSM1872973","GSM1872945","GSM2042068","GSM1872942","GSM2042116","GSM1872983","GSM1872958","GSM1872955","GSM1872917","GSM2042104","GSM1545678","GSM2111660","GSM2111658","GSM1847263","GSM1872923","GSM2042062","GSM2042084","GSM2042066","GSM1980051","GSM1872989","GSM2157837","GSM2042086","GSM2131811","GSM2042135","GSM1545679","GSM1872918","GSM1872929",
"GSM2042103","GSM1971014","GSM2042076","GSM2042139","GSM1505579","GSM2042109","GSM1980049","GSM2042097","GSM1872933","GSM2042085","GSM2042077","GSM1872932","GSM1872936","GSM1872915","GSM1872930","GSM1545674","GSM1528138","GSM1872981","GSM2042124","GSM2042092","GSM2042063","GSM1872961","GSM1528134","GSM1872968","GSM2042074","GSM2042114","GSM1872957","GSM1872946","GSM1872991","GSM2042073",
"GSM1872952","GSM1545675","GSM2042101","GSM2042130","GSM2042064","GSM1306819","GSM1872970","GSM2055786","GSM2042122","GSM1412745","GSM2042132","GSM1872910","GSM1872974","GSM2042088","GSM2042102","GSM1872907","GSM2042141","GSM2042087","GSM2042134","GSM1872953","GSM2042081","GSM1847265","GSM1872934","GSM2042080","GSM2042093","GSM1436137","GSM1872959","GSM1872944","GSM1872924","GSM2330187",
"GSM1872920","GSM2042089","GSM1872951","GSM2042107","GSM2042115","GSM2042126","GSM1872950","GSM1872939","GSM2042094","GSM1306821","GSM2042131","GSM1872943","GSM2042127","GSM2042065","GSM1872967","GSM1872963","GSM2042096","GSM1971015","GSM1872916","GSM1545677","GSM2042059","GSM2042082","GSM2042060","GSM2042070","GSM1872964","GSM1872911","GSM1872931","GSM2042075","GSM1847266","GSM1872976",
"GSM1980047","GSM1872941","GSM1306816","GSM1872949","GSM1872947","GSM1872908","GSM2131810","GSM2042106","GSM1306818","GSM2042061","GSM1436138","GSM1872979","GSM2042083","GSM2042119","GSM1980053","GSM1872921","GSM1545676","GSM1980052","GSM1872909","GSM2042091","GSM1872919","GSM1872987","GSM1872954","GSM2042090","GSM2042117","GSM2042118","GSM2042098","GSM1847264","GSM1872971","GSM2042105",
"GSM1436136","GSM1872975","GSM2042113","GSM1412746","GSM1703048","GSM1659544","GSM1659546","GSM2127806","GSM1616942","GSM1703029","GSM1703044","GSM1616914","GSM1703041","GSM1616924","GSM1703042","GSM1616938","GSM1616918","GSM1919397","GSM1616927","GSM1703047","GSM1919393","GSM1857419","GSM1616941","GSM1616926","GSM1857420","GSM1616929","GSM2127804","GSM1432898","GSM1616920","GSM2127805",
"GSM1919395","GSM1703037","GSM2127807","GSM1703043","GSM1919382","GSM1616919","GSM2127809","GSM1616930","GSM1857417","GSM1703039","GSM1432895","GSM1703027","GSM1703030","GSM1703040","GSM1857421","GSM1659547","GSM1616931","GSM1919387","GSM1616933","GSM1432897","GSM1659545","GSM1919404","GSM1703031","GSM1703034","GSM1703028","GSM1919399","GSM1616943","GSM1857416","GSM1616935","GSM1703046",
"GSM1616936","GSM1616915","GSM1703049","GSM2113308","GSM1857418","GSM1616932","GSM1919402","GSM1616944","GSM1616939","GSM1616922","GSM1616917","GSM1919380","GSM1703038","GSM1616913","GSM1616928","GSM1703032","GSM1659543","GSM1919384","GSM1616937","GSM1616921","GSM1703036","GSM1616923","GSM1703033","GSM1616916","GSM2127808","GSM1919389","GSM1432896","GSM1616912","GSM1616925","GSM1616934",
"GSM1703026","GSM1659548","GSM1919378","GSM1919374","GSM1616940","GSM1919391","GSM1703045","GSM1703035","GSM1306817","GSM1436135","GSM1872948","GSM1872927","GSM1872969","GSM1872906","GSM1971012","GSM1980046","GSM2042079","GSM2042133","GSM2042142","GSM2042121","GSM2042100","GSM2042058","GSM2111659","GSM2157836","GSM1906836","GSM1906837","GSM1906838","GSM1906865","GSM1906864","GSM1906861",
"GSM1906860","GSM1906863","GSM1906862","GSM1906839","GSM1906858","GSM1906859","GSM1906850","GSM1906851","GSM1906852","GSM1906853","GSM1906854","GSM1906855","GSM1906856","GSM1906857","GSM1906849","GSM1906848","GSM1906847","GSM1906846","GSM1906845","GSM1906844","GSM1906843","GSM1906842","GSM1906841","GSM1906840","GSM2359808","GSM2359809","GSM2359806","GSM2359807","GSM2359804","GSM2359805",
"GSM2359802","GSM2359803","GSM2343211","GSM1010974","GSM2387340","GSM2387341","GSM2343672","GSM2343949","GSM2359811","GSM2359810","GSM2359813","GSM2359812","GSM1120315","GSM2344169","GSM2344186","GSM1010942","GSM2343980","GSM2387337","GSM2387336","GSM2387335","GSM2387339","GSM2387338","GSM2344258","GSM2387334","GSM2344212","GSM1915705","GSM1915708","GSM1915706","GSM1915704","GSM1915707",
"GSM1915709","GSM2545891","GSM2545877","GSM2545878","GSM2545885","GSM2545883","GSM2545874","GSM2545882","GSM2545881","GSM2545889","GSM2545884","GSM2545896","GSM2545876","GSM2545880","GSM2545873","GSM2545886","GSM2545879","GSM2545888","GSM2545892","GSM2545894","GSM2545895","GSM2545893","GSM2545890","GSM2545875","GSM2545887","GSM2355695","GSM2355696","GSM2355697","GSM2453436","GSM2459953",
"GSM2459954","GSM2459955","GSM2459956","GSM2212624","GSM2212625","GSM2212628","GSM2212629","GSM2212631","GSM2212632","GSM2212636","GSM2212637","GSM2212640","GSM2212641","GSM2212642","GSM2212643","GSM2212644","GSM2212645","GSM2212647","GSM2212648","GSM2212650","GSM2212651","GSM2212653","GSM2212654","GSM2212655","GSM2212657","GSM2212665","GSM2212666","GSM2212667","GSM2212668","GSM2212669",
"GSM2212677","GSM2212679","GSM2212680","GSM2212681","GSM2212682","GSM2212685","GSM2212686","GSM2212687","GSM2212689","GSM2212693","GSM2212697","GSM2212700","GSM2212702","GSM2212705","GSM2212706","GSM2212712","GSM2212714","GSM2212715","GSM2212716","GSM2212717","GSM2212720","GSM2212723","GSM2212724","GSM2212725","GSM2212726","GSM2212727","GSM2212728","GSM2212729","GSM2212733","GSM2212736",
"GSM2212740","GSM2212741","GSM2212744","GSM2212745","GSM2212746","GSM2212747","GSM2212748","GSM2212751","GSM2212753","GSM2212755","GSM2344507","GSM2344508","GSM2344509","GSM2344510","GSM2344511","GSM2344512","GSM2344513","GSM2344514","GSM2344515","GSM2344516","GSM2453437","GSM2748316","GSM2748317","GSM2748318","GSM2748319","GSM2748320","GSM2748321","GSM2748322","GSM2748323","GSM2748324",
"GSM2633898","GSM2633899","GSM2633900","GSM2633901","GSM2633902","GSM2633903","GSM2633904","GSM2633905","GSM2633906","GSM2633907","GSM2633908","GSM2633909","GSM2633910","GSM2633911","GSM2913923","GSM2913924","GSM2913925","GSM2913926","GSM2464761","GSM2464762","GSM2464763","GSM2464764","GSM2464765","GSM2464766","GSM2464767","GSM2464768","GSM2464769","GSM2464770","GSM2464771","GSM2464772",
"GSM2464773","GSM2464774","GSM2464775","GSM2464776","GSM2464777","GSM2464778","GSM2464779","GSM2464780","GSM2496685","GSM2496686","GSM2496687","GSM2496688","GSM2496689","GSM2496690","GSM2496691","GSM2496692","GSM2496693","GSM2496694","GSM2496695","GSM2496696","GSM2496697","GSM2496698","GSM2496699","GSM2496700","GSM2496701","GSM2496702","GSM2496703","GSM2496704","GSM2496705","GSM2496706",
"GSM2496707","GSM2496708","GSM2496709","GSM2496710","GSM2496711","GSM2496712","GSM2496713","GSM2496714","GSM2496715","GSM1892616","GSM2343309","GSM2343361","GSM2343560","GSM2343804","GSM2343963","GSM2344290","GSM2344291","GSM2344399","GSM2478593","GSM2478594","GSM2478595","GSM2511540","GSM2511541","GSM2511542","GSM2511543","GSM2511544","GSM2511545","GSM2511546","GSM2511547","GSM2511548",
"GSM2511549","GSM2511550","GSM2511551","GSM2511552","GSM2511553","GSM2511554","GSM2511555","GSM2511556","GSM2511557","GSM2511558","GSM2511559","GSM2511560","GSM2511561","GSM2511562","GSM2511563","GSM2511564","GSM2511565","GSM2511566","GSM2511567","GSM2511568","GSM2511569","GSM2511570","GSM2511571","GSM2511572","GSM2511573","GSM2511574","GSM2511575","GSM2511576","GSM2511577","GSM2511578",
"GSM2511579","GSM2511580","GSM2511581","GSM2511582","GSM2511583","GSM2511584","GSM2511585","GSM2511586","GSM2511587","GSM2511588","GSM2511589","GSM2511590","GSM2511591","GSM2511592","GSM2511593","GSM2511594","GSM2511595","GSM2511596","GSM2511597","GSM2511598","GSM2511599","GSM2511600","GSM2511601","GSM2511602","GSM2511603","GSM2511604","GSM2511605","GSM2511606","GSM2511607","GSM2511608",
"GSM2511609","GSM2511610","GSM2511611","GSM2511612","GSM2511613","GSM2511614","GSM2511615","GSM2511616","GSM2511617","GSM2511618","GSM2511619","GSM2511620","GSM2511621","GSM2511622","GSM2511623","GSM2511624","GSM2511625","GSM2511626","GSM2511627","GSM2511628","GSM2511629","GSM2511630","GSM2511631","GSM2511632","GSM2511633","GSM2705897","GSM2705898","GSM2705899","GSM2705900","GSM2701546",
"GSM2701547","GSM2701548","GSM2701549","GSM2701550","GSM2701551","GSM2701552","GSM2701553","GSM2701554","GSM2701555","GSM2701556","GSM2701557","GSM3028476","GSM3028490","GSM2871805","GSM2871806","GSM2871807","GSM2871808","GSM2871809","GSM2871810","GSM2871811","GSM2871812","GSM2871813","GSM2871814","GSM2871815","GSM2871816","GSM2871817","GSM2871818","GSM2871819","GSM2871820","GSM2871821",
"GSM2871822","GSM2871823","GSM2871824","GSM2871825","GSM2871826","GSM2871827","GSM2871828","GSM2871829","GSM2871830","GSM2871831","GSM2871832","GSM2871833","GSM2871834","GSM2871835","GSM2871836","GSM2871837","GSM2871838","GSM2871839","GSM2871840","GSM2871841","GSM2871842","GSM2871843","GSM2871844","GSM2871845","GSM2871846","GSM2871847","GSM2871848","GSM2871849","GSM2871850","GSM2871851",
"GSM2871852","GSM2808523","GSM2808524","GSM2049403","GSM2049404","GSM2049405","GSM2186529","GSM2186530","GSM2409869","GSM2409870","GSM2409871","GSM2409872","GSM2409873","GSM2418913","GSM2418914","GSM2418915","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
