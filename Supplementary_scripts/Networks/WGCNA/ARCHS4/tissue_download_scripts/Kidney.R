# R script to download selected samples
# Copy code and run on a local machine to initiate download

# Check for dependencies and install if missing
packages <- c("rhdf5")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    print("Install required packages")
    source("https://bioconductor.org/biocLite.R")
    biocLite("rhdf5")
}
library("rhdf5")
library("tools")

destination_file = "human_matrix_download.h5"
extracted_expression_file = "Kidney_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix.h5"

# Check if gene expression file was already downloaded and check integrity, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE)
} else{
    print("Verifying file integrity...")
    checksum = md5sum(destination_file)
    
    if(destination_file == "human_matrix_download.h5"){
        # human checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "f78da4a1855ff20da768eed1b73508be"
    } else{
        # mouse checksum (checksum is for latest version of ARCHS4 data)
        correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
    }
    
    if(checksum != correct_checksum){
        print("Existing file looks corrupted or is out of date. Downloading compressed gene expression matrix again.")
        download.file(url, destination_file, quiet = FALSE)
    } else{
        print("Latest ARCHS4 file already exists.")
    }
}

checksum = md5sum(destination_file)
if(destination_file == "human_matrix_download.h5"){
    # human checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "f78da4a1855ff20da768eed1b73508be"
} else{
    # mouse checksum (checksum is for latest version of ARCHS4 data)
    correct_checksum = "065abb20d2b9d2661e74328de8d23eb3"
}

if(checksum != correct_checksum){
    print("File download ran into problems. Please try to download again. The files are also available for manual download at http://amp.pharm.mssm.edu/archs4/download.html.")
} else{
    # Selected samples to be extracted
    samp = c("GSM742943","GSM1220265","GSM1220268","GSM1198468","GSM1220269","GSM1198467","GSM1220264","GSM1220267","GSM1220262","GSM1198469","GSM1220263","GSM1198470","GSM1198465","GSM977615","GSM1220266","GSM1198466","GSM977618","GSM977617","GSM1623144","GSM1808015","GSM2359147","GSM1623146","GSM2359154","GSM1808009","GSM1350200","GSM1623141","GSM1941671","GSM2288689","GSM1543547","GSM1807997","GSM1808008",
"GSM1970534","GSM1970541","GSM2359150","GSM1808011","GSM1808003","GSM1808006","GSM1543544","GSM2359146","GSM1350196","GSM2359148","GSM1659005","GSM2288687","GSM1543546","GSM1659004","GSM2359145","GSM1807999","GSM1623145","GSM1904618","GSM1682268","GSM1567932","GSM1941672","GSM1350193","GSM1970533","GSM1350197","GSM2288690","GSM2071704","GSM1505597","GSM1350201","GSM2359149","GSM2359151",
"GSM1623140","GSM1567930","GSM1807998","GSM1623149","GSM1505570","GSM2288695","GSM1970539","GSM1623143","GSM2288693","GSM1350194","GSM1623147","GSM1359854","GSM2359155","GSM1970535","GSM1970540","GSM1359855","GSM1682266","GSM1623148","GSM1970532","GSM1970537","GSM2288692","GSM1808014","GSM1808001","GSM1682269","GSM2288688","GSM1808005","GSM1970536","GSM1567931","GSM2359156","GSM1695198",
"GSM2359152","GSM2359153","GSM2071703","GSM1623142","GSM2288696","GSM1808004","GSM1808010","GSM1350198","GSM1970538","GSM2288685","GSM1808012","GSM1682267","GSM1808016","GSM1808013","GSM1350199","GSM1659010","GSM1505569","GSM2359144","GSM1808002","GSM2288691","GSM2288694","GSM2288686","GSM1695197","GSM1659006","GSM1543545","GSM1695199","GSM1808000","GSM2127803","GSM2132128","GSM2132132",
"GSM1129242","GSM2127800","GSM2132130","GSM1465293","GSM2132129","GSM2127801","GSM2113309","GSM2132133","GSM2132131","GSM1370364","GSM1129241","GSM2127802","GSM1129240","GSM2127799","GSM2127798","GSM1465294","GSM1350195","GSM1350192","GSM1359853","GSM1808007","GSM2071702","GSM2186963","GSM2186962","GSM2186961","GSM2186960","GSM2186967","GSM2186966","GSM2186965","GSM2186964","GSM1811426",
"GSM1811427","GSM1811424","GSM1811425","GSM1811428","GSM1811429","GSM1811431","GSM1811430","GSM2186956","GSM2186957","GSM2186958","GSM2186959","GSM1059488","GSM1059489","GSM1059501","GSM1059503","GSM1059502","GSM1059504","GSM1059528","GSM1059523","GSM1059527","GSM1059526","GSM2072540","GSM1059497","GSM1059493","GSM1059492","GSM1059491","GSM1059490","GSM1059499","GSM1059510","GSM1059511",
"GSM2072539","GSM1059524","GSM2408054","GSM2408055","GSM2408049","GSM2408051","GSM2408050","GSM2408052","GSM2408057","GSM2408058","GSM2408059","GSM2408062","GSM2408097","GSM2408099","GSM2408101","GSM2408104","GSM2408116","GSM2408118","GSM2408119","GSM2408120","GSM2397761","GSM2397762","GSM2397763","GSM2397764","GSM2397765","GSM2397766","GSM2397767","GSM2397772","GSM2397775","GSM2397776",
"GSM2397777","GSM2397778","GSM2397780","GSM2397779","GSM2397782","GSM2397783","GSM2397784","GSM2397785","GSM2397786","GSM2397788","GSM2397789","GSM2397787","GSM2397790","GSM2397791","GSM2397792","GSM2397800","GSM2397801","GSM2397806","GSM2397734","GSM2397735","GSM2408048","GSM2408053","GSM2408056","GSM2408061","GSM2408063","GSM2408064","GSM2408071","GSM2408073","GSM2408074","GSM2408076",
"GSM2408077","GSM2408080","GSM2408094","GSM2408095","GSM2408100","GSM2408107","GSM2408114","GSM2408115","GSM2408117","GSM2408123","GSM2408122","GSM2408124","GSM2408126","GSM2408127","GSM2408128","GSM2408131","GSM2408134","GSM2408135","GSM2408136","GSM2408137","GSM2408138","GSM2408142","GSM2408153","GSM2397693","GSM2397701","GSM2397718","GSM2397723","GSM2397726","GSM2397727","GSM2397729",
"GSM2397736","GSM2397738","GSM2397768","GSM2397781","GSM2397817","GSM2408113","GSM2397728","GSM2397733","GSM2397758","GSM2397759","GSM2397647","GSM2397648","GSM2397649","GSM2397651","GSM2397652","GSM2397653","GSM2397654","GSM2397655","GSM2397656","GSM2397657","GSM2397658","GSM2397659","GSM2397660","GSM2397677","GSM2397678","GSM2397685","GSM2397687","GSM2397690","GSM2397694","GSM2397702",
"GSM2397712","GSM2397711","GSM2397716","GSM2397717","GSM2397725","GSM2397731","GSM2397730","GSM2397732","GSM2397760","GSM2397770","GSM2397769","GSM2397771","GSM2397773","GSM2397774","GSM2397798","GSM2397799","GSM2397803","GSM2397802","GSM2397804","GSM2397805","GSM2397807","GSM2397813","GSM2397814","GSM2397818","GSM2408091","GSM2408096","GSM2408102","GSM2408105","GSM2408109","GSM2408110",
"GSM2408111","GSM2408112","GSM2397737","GSM2397739","GSM2397812","GSM2408083","GSM2408089","GSM2397671","GSM2397672","GSM2397680","GSM2397681","GSM2397683","GSM2397686","GSM2397688","GSM2397691","GSM2397695","GSM2397696","GSM2397710","GSM2397720","GSM2397722","GSM2397724","GSM2397740","GSM2397815","GSM2397816","GSM2408060","GSM2408066","GSM2408067","GSM2408068","GSM2408069","GSM2408070",
"GSM2408072","GSM2408078","GSM2408085","GSM2408084","GSM2408093","GSM2408125","GSM2408129","GSM2408130","GSM2408132","GSM2408133","GSM2408139","GSM2408144","GSM2408145","GSM2408146","GSM2408143","GSM2408149","GSM2408150","GSM2408151","GSM2408152","GSM2408154","GSM2408156","GSM2408157","GSM2397661","GSM2397743","GSM2397747","GSM2408103","GSM2397662","GSM2397692","GSM2397700","GSM2397741",
"GSM2397745","GSM2397753","GSM2397754","GSM2397755","GSM2397757","GSM2408090","GSM2408106","GSM2397663","GSM2397664","GSM2397666","GSM2397667","GSM2397668","GSM2397669","GSM2397670","GSM2397673","GSM2397679","GSM2397682","GSM2397684","GSM2397697","GSM2397698","GSM2397703","GSM2397704","GSM2397707","GSM2397709","GSM2397708","GSM2397713","GSM2397715","GSM2397714","GSM2397719","GSM2397721",
"GSM2408108","GSM2397742","GSM2397746","GSM2397756","GSM2397793","GSM2397794","GSM2397795","GSM2397808","GSM2397811","GSM2397744","GSM2397810","GSM2397632","GSM2397634","GSM2397635","GSM2397650","GSM2397665","GSM2397699","GSM2397748","GSM2397750","GSM2397749","GSM2408075","GSM2397674","GSM2397752","GSM2397642","GSM2397645","GSM2397646","GSM2397675","GSM2397676","GSM2397689","GSM2397796",
"GSM2397809","GSM2397819","GSM2408081","GSM2408082","GSM2408147","GSM2397751","GSM2397633","GSM2397705","GSM2397797","GSM2408065","GSM2408079","GSM2408086","GSM2408092","GSM2408141","GSM2397641","GSM2397643","GSM2397706","GSM2408148","GSM2408140","GSM2397639","GSM2397638","GSM2397644","GSM2408088","GSM2397820","GSM2397821","GSM2397637","GSM2397640","GSM2397636","GSM2458803","GSM2458807",
"GSM2458802","GSM2458799","GSM2458800","GSM2458806","GSM2458805","GSM2458801","GSM2458804","GSM2453419","GSM2723919","GSM2723921","GSM2723923","GSM2723925","GSM2723927","GSM2723929","GSM2723931","GSM2723933","GSM2723935","GSM2723937","GSM2453418","GSM2455389","GSM2455390","GSM2455391","GSM2455392","GSM2455393","GSM2455394","GSM2455395","GSM2455396","GSM2455397","GSM2455398","GSM2455399",
"GSM2455400","GSM2455401","GSM2455402","GSM2455403","GSM2455404","GSM2563040","GSM2563041","GSM2563042","GSM2609164","GSM2609165","GSM2609166","GSM2609167","GSM2609168","GSM2609169","GSM2609170","GSM2609171","GSM1611873","GSM1611874","GSM2649068","GSM2649069","GSM1867011","GSM1867012","GSM1867013","GSM1867014","GSM1920902","GSM1920903","GSM1920904","GSM1920905","GSM1920906","GSM1920907",
"GSM1920908","GSM1920909","GSM2434132","GSM2434133","GSM2434134","GSM2467589","GSM2467590","GSM2467591","GSM2467592","GSM2695311","GSM2695312","GSM2695313","GSM2695314","GSM2695315","GSM2695316","GSM2695317","GSM2695318","GSM2695319","GSM2730943","GSM2730944","GSM2730945","GSM2730946","GSM2730947","GSM2730948","GSM2730949","GSM2730950","GSM2730951","GSM2730952","GSM2730953","GSM2730954",
"GSM2730955","GSM2730956","GSM2730957","GSM2730958","GSM2730959","GSM2730960","GSM2730961","GSM2730962","GSM2741551","GSM2773437","GSM2773438","GSM2773439","GSM2773440","GSM2773441","GSM2773442","GSM2773443","GSM2773444","GSM2773445","GSM2773446","GSM2773447","GSM2773448","GSM1382090","GSM2705909","GSM2705910","GSM2705911","GSM2705912","GSM2935199","GSM2935200","GSM2935201","GSM2949336",
"GSM2949337","GSM2949338","GSM2949339","GSM3103088","GSM3103089","GSM3099836","GSM3099837","GSM3099838","GSM3099839","GSM3099840","GSM3099841","GSM3099842","GSM3099843","GSM3099844","GSM3099845","GSM2863095","GSM2863096","GSM2863097","GSM2863098","GSM2863099","GSM2863100","GSM2902702","GSM2902703","GSM2902704","GSM2902705","GSM2902706","GSM2902707","GSM2902708","GSM2902709","GSM2902710",
"GSM2902711","GSM2902712","GSM2902713","GSM2902714","GSM2902715","GSM2902716","GSM2902717","GSM2902718","GSM2902719","GSM2902720","GSM2902721","GSM2902722","GSM3073088","GSM3073089","GSM2443359","GSM2443360","GSM2443361","GSM2443362","GSM2443363","GSM2443364","GSM2443365","GSM2443366","GSM2443367","GSM2443368","GSM2443369","GSM2443370","GSM2443371","GSM2443372","GSM2443373","GSM2443374",
"GSM2443375","GSM2443376","GSM2443377","GSM2443378","GSM2443379","GSM2443380","GSM2443381","GSM2443382","GSM2443383","GSM2443384","GSM2443385","GSM2443386","GSM2443387","GSM2443388","GSM2443389","GSM2443390","GSM2443391","GSM2443392","GSM2443393","GSM2443394","")

    # Retrieve information from compressed data
    samples = h5read(destination_file, "meta/Sample_geo_accession")
    tissue = h5read(destination_file, "meta/Sample_source_name_ch1")
    genes = h5read(destination_file, "meta/genes")

    # Identify columns to be extracted
    sample_locations = which(samples %in% samp)

    # extract gene expression from compressed data
    expression = h5read(destination_file, "data/expression", index=list(1:length(genes), sample_locations))
    H5close()
    rownames(expression) = genes
    colnames(expression) = samples[sample_locations]

    # Print file
    write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE)
    print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))
}
